<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gym Tracker Pro v4</title>

<link rel="manifest" href="./manifest.json" />
<meta name="theme-color" content="#09090b" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-title" content="Gym Tracker" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link rel="apple-touch-icon" href="./icons/apple-touch-icon.png" />
<link rel="icon" sizes="32x32" href="./icons/icon-32.png" />
<link rel="icon" sizes="192x192" href="./icons/icon-192.png" />
<link rel="icon" sizes="512x512" href="./icons/icon-512.png" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-zinc-950 text-zinc-100">
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useMemo, useState } = React;

      // --------- utils ----------
      const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);
      const todayISO = () => new Date().toISOString().slice(0, 10);
      const toNum = (v) => (v === "" || v === null || v === undefined ? null : Number(v));
      const safe = (n, fallback = 0) => (Number.isFinite(n) ? n : fallback);

      function load(key, fallback) {
        try {
          const raw = localStorage.getItem(key);
          return raw ? JSON.parse(raw) : fallback;
        } catch {
          return fallback;
        }
      }
      function save(key, value) {
        localStorage.setItem(key, JSON.stringify(value));
      }

      function startOfWeekISO(dateISO) {
        const d = new Date(dateISO + "T00:00:00");
        const day = (d.getDay() + 6) % 7; // Mon=0..Sun=6
        d.setDate(d.getDate() - day);
        return d.toISOString().slice(0, 10);
      }
      function addDaysISO(dateISO, days) {
        const d = new Date(dateISO + "T00:00:00");
        d.setDate(d.getDate() + days);
        return d.toISOString().slice(0, 10);
      }
      function inWeek(dateISO, weekStartISO) {
        return dateISO >= weekStartISO && dateISO <= addDaysISO(weekStartISO, 6);
      }
      function weekdayIndexMon0(dateISO) {
        const d = new Date(dateISO + "T00:00:00");
        return (d.getDay() + 6) % 7; // Mon=0
      }

      function volumeForSet(set) {
        const reps = toNum(set.reps);
        const weight = toNum(set.weight);
        if (reps == null || weight == null) return 0;
        return reps * weight;
      }
      function volumeForExercise(ex) {
        return (ex.sets || []).reduce((acc, s) => acc + volumeForSet(s), 0);
      }
      function countedSets(ex) {
        return (ex.sets || []).filter((s) => (toNum(s.reps) ?? 0) > 0).length;
      }

      const MUSCLES = [
        "Chest","Back","Shoulders","Biceps","Triceps","Quads","Hamstrings","Glutes","Calves","Abs","Other"
      ];

      // --------- UI components ----------
      function Card({ children }) {
        return React.createElement(
          "div",
          { className: "rounded-2xl bg-zinc-900/60 border border-zinc-800 shadow p-4 md:p-5" },
          children
        );
      }
      function Label({ children }) {
        return React.createElement("div", { className: "text-xs text-zinc-400 mb-1" }, children);
      }
      function Input(props) {
        return React.createElement("input", {
          ...props,
          className:
            "w-full rounded-xl bg-zinc-950 border border-zinc-800 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-zinc-600 " +
            (props.className || ""),
        });
      }
      function TextArea(props) {
        return React.createElement("textarea", {
          ...props,
          className:
            "w-full rounded-xl bg-zinc-950 border border-zinc-800 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-zinc-600 " +
            (props.className || ""),
        });
      }
      function Button({ children, variant = "primary", ...props }) {
        const styles =
          variant === "primary"
            ? "bg-zinc-100 text-zinc-950 hover:bg-white"
            : variant === "ghost"
            ? "bg-transparent border border-zinc-800 hover:bg-zinc-900"
            : "bg-red-500/90 hover:bg-red-500 text-white";
        return React.createElement(
          "button",
          {
            ...props,
            className:
              "rounded-xl px-3 py-2 text-sm font-medium transition active:scale-[0.99] disabled:opacity-50 " +
              styles +
              " " +
              (props.className || ""),
          },
          children
        );
      }
      function Pill({ active, children, onClick }) {
        return React.createElement(
          "button",
          {
            onClick,
            className:
              "px-3 py-1.5 rounded-full text-sm border transition " +
              (active
                ? "bg-zinc-100 text-zinc-950 border-zinc-100"
                : "bg-transparent text-zinc-200 border-zinc-800 hover:bg-zinc-900"),
          },
          children
        );
      }
      function Empty({ title, hint }) {
        return React.createElement(
          "div",
          { className: "text-center py-10 text-zinc-400" },
          React.createElement("div", { className: "text-zinc-200 font-semibold" }, title),
          React.createElement("div", { className: "text-sm mt-1" }, hint)
        );
      }

      // --------- progression logic (1kg jumps) ----------
      function suggestNextWeight({ lastWeight, hitTargetAllSets, missByALot }) {
        if (lastWeight == null) return null;
        if (hitTargetAllSets) return +(lastWeight + 1).toFixed(1);
        if (missByALot) return +(Math.max(0, lastWeight - 1)).toFixed(1);
        return lastWeight;
      }

      // --------- default splits ----------
      function defaultSplits() {
        return [
          {
            id: uid(),
            name: "PPL (6 days)",
            days: [
              { id: uid(), name: "Push", templateIds: [] },
              { id: uid(), name: "Pull", templateIds: [] },
              { id: uid(), name: "Legs", templateIds: [] },
              { id: uid(), name: "Push", templateIds: [] },
              { id: uid(), name: "Pull", templateIds: [] },
              { id: uid(), name: "Legs", templateIds: [] },
              { id: uid(), name: "Rest", templateIds: [] },
            ],
          },
          {
            id: uid(),
            name: "Upper / Lower (4 days)",
            days: [
              { id: uid(), name: "Upper", templateIds: [] },
              { id: uid(), name: "Lower", templateIds: [] },
              { id: uid(), name: "Rest", templateIds: [] },
              { id: uid(), name: "Upper", templateIds: [] },
              { id: uid(), name: "Lower", templateIds: [] },
              { id: uid(), name: "Rest", templateIds: [] },
              { id: uid(), name: "Rest", templateIds: [] },
            ],
          },
          {
            id: uid(),
            name: "Full Body (3 days)",
            days: [
              { id: uid(), name: "Full Body", templateIds: [] },
              { id: uid(), name: "Rest", templateIds: [] },
              { id: uid(), name: "Full Body", templateIds: [] },
              { id: uid(), name: "Rest", templateIds: [] },
              { id: uid(), name: "Full Body", templateIds: [] },
              { id: uid(), name: "Rest", templateIds: [] },
              { id: uid(), name: "Rest", templateIds: [] },
            ],
          },
        ];
      }

      function App() {
        const STORAGE_KEY = "gym_tracker_pro_v4";

        const [state, setState] = useState(() =>
          load(STORAGE_KEY, {
            exerciseLibrary: {
              "Bench Press": { muscle: "Chest" },
              "Incline DB Press": { muscle: "Chest" },
              "Lat Pulldown": { muscle: "Back" },
              "Seated Row": { muscle: "Back" },
              "Squat": { muscle: "Quads" },
              "RDL": { muscle: "Hamstrings" },
            },
            templates: [
              {
                id: uid(),
                name: "Upper (Strength)",
                type: "strength",
                exercises: [
                  { id: uid(), name: "Bench Press", repTarget: 8 },
                  { id: uid(), name: "Incline DB Press", repTarget: 10 },
                  { id: uid(), name: "Lat Pulldown", repTarget: 10 },
                  { id: uid(), name: "Seated Row", repTarget: 10 },
                ],
              },
              {
                id: uid(),
                name: "Lower (Strength)",
                type: "strength",
                exercises: [
                  { id: uid(), name: "Squat", repTarget: 6 },
                  { id: uid(), name: "RDL", repTarget: 8 },
                  { id: uid(), name: "Leg Press", repTarget: 10 },
                  { id: uid(), name: "Calf Raises", repTarget: 12 },
                ],
              },
              {
                id: uid(),
                name: "Zone 2 Cardio",
                type: "cardio",
                cardio: { modality: "Bike", minutes: 30, distanceKm: "" },
              },
            ],
            splits: [],
            activeSplitId: null,

            // ✅ NEW: settings
            settings: {
              splitMode: "calendar", // "calendar" | "cycle"
            },

            // ✅ NEW: cycle position per split
            splitCycleIndexBySplitId: {},

            sessions: [],
            macroEntries: [],
            bodyEntries: [],
          })
        );

        // init splits if empty
        useEffect(() => {
          setState((s) => {
            if (s.splits && s.splits.length) return s;
            const splits = defaultSplits();
            const activeSplitId = splits[0]?.id || null;
            return { ...s, splits, activeSplitId };
          });
        }, []);

        useEffect(() => save(STORAGE_KEY, state), [state]);

        const [tab, setTab] = useState("sessions"); // sessions | templates | split | settings | history | macros | body | weekly
        const [weekStart, setWeekStart] = useState(startOfWeekISO(todayISO()));

        // ---- helpers ----
        function ensureLibraryForExercise(name, muscle) {
          const key = (name || "").trim();
          if (!key) return;
          setState((s) => {
            const prev = s.exerciseLibrary?.[key];
            if (prev && prev.muscle) return s;
            return { ...s, exerciseLibrary: { ...(s.exerciseLibrary || {}), [key]: { muscle: muscle || "Other" } } };
          });
        }

        function updateSession(id, updater) {
          setState((s) => ({
            ...s,
            sessions: s.sessions.map((x) => (x.id === id ? updater(x) : x)),
          }));
        }
        function deleteSession(id) {
          setState((s) => ({ ...s, sessions: s.sessions.filter((x) => x.id !== id) }));
        }

        const sortedSessions = useMemo(() => {
          return [...state.sessions].sort((a, b) => (a.date < b.date ? 1 : -1));
        }, [state.sessions]);

        // ---- active split ----
        const activeSplit = useMemo(() => {
          return (state.splits || []).find((sp) => sp.id === state.activeSplitId) || null;
        }, [state.splits, state.activeSplitId]);

        // cycle index helpers
        function getCycleIndexForActiveSplit() {
          const sid = state.activeSplitId;
          if (!sid) return 0;
          return safe(state.splitCycleIndexBySplitId?.[sid], 0);
        }
        function setCycleIndexForActiveSplit(nextIndex) {
          const sid = state.activeSplitId;
          if (!sid) return;
          setState((s) => ({
            ...s,
            splitCycleIndexBySplitId: { ...(s.splitCycleIndexBySplitId || {}), [sid]: nextIndex },
          }));
        }

        function normalizeSplitDays(split) {
          const days = split?.days || [];
          // ensure at least 1 day
          return days.length ? days : [{ id: uid(), name: "Day 1", templateIds: [] }];
        }

        // ---- Today’s Plan (calendar OR cycle) ----
        const plan = useMemo(() => {
          if (!activeSplit) return null;

          const days = normalizeSplitDays(activeSplit);
          const mode = state.settings?.splitMode || "calendar";

          if (mode === "calendar") {
            // if user kept 7 days, this maps nicely. If not 7, we wrap.
            const idx = weekdayIndexMon0(todayISO()) % days.length;
            const day = days[idx];
            const templates = (day.templateIds || [])
              .map((id) => state.templates.find((t) => t.id === id))
              .filter(Boolean);
            const weekdayLabel = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"][weekdayIndexMon0(todayISO())];
            return { mode, title: `${weekdayLabel}: ${day.name}`, dayIndex: idx, dayCount: days.length, day, templates };
          }

          // cycle mode
          const idx = getCycleIndexForActiveSplit() % days.length;
          const day = days[idx];
          const templates = (day.templateIds || [])
            .map((id) => state.templates.find((t) => t.id === id))
            .filter(Boolean);
          return { mode, title: `Cycle Day ${idx + 1} of ${days.length}: ${day.name}`, dayIndex: idx, dayCount: days.length, day, templates };
        }, [activeSplit, state.settings, state.templates, state.splitCycleIndexBySplitId]);

        function addSessionFromTemplate(tplId) {
          const tpl = state.templates.find((t) => t.id === tplId);
          if (!tpl) return;

          if (tpl.type === "strength") {
            const sess = {
              id: uid(),
              date: todayISO(),
              name: tpl.name,
              type: "strength",
              notes: "",
              strength: {
                exercises: (tpl.exercises || []).map((e) => {
                  const muscle = state.exerciseLibrary?.[e.name]?.muscle || "Other";
                  return {
                    id: uid(),
                    name: e.name,
                    muscle,
                    repTarget: e.repTarget ?? 8,
                    sets: [{ id: uid(), reps: "", weight: "", rpe: "" }],
                  };
                }),
              },
            };
            setState((s) => ({ ...s, sessions: [sess, ...s.sessions] }));
          } else {
            const sess = {
              id: uid(),
              date: todayISO(),
              name: tpl.name,
              type: "cardio",
              notes: "",
              cardio: {
                modality: tpl.cardio?.modality || "Run",
                minutes: tpl.cardio?.minutes ?? 30,
                distanceKm: tpl.cardio?.distanceKm ?? "",
                intensity: "Zone 2",
              },
            };
            setState((s) => ({ ...s, sessions: [sess, ...s.sessions] }));
          }
          setTab("sessions");
        }

        // ---- Templates ----
        const [tplType, setTplType] = useState("strength");
        const [tplName, setTplName] = useState("");
        const [tplExercises, setTplExercises] = useState("Bench Press,8,Chest\nRow,10,Back\nSquat,6,Quads");
        const [tplCardioMod, setTplCardioMod] = useState("Bike");
        const [tplCardioMin, setTplCardioMin] = useState("30");
        const [tplCardioDist, setTplCardioDist] = useState("");

        function addTemplate() {
          const name = tplName.trim();
          if (!name) return;

          if (tplType === "strength") {
            const lines = tplExercises
              .split("\n")
              .map((x) => x.trim())
              .filter(Boolean)
              .map((line) => {
                const parts = line.split(",").map((s) => s.trim());
                const n = parts[0];
                const rt = toNum(parts[1]) ?? 8;
                const muscle = MUSCLES.includes(parts[2]) ? parts[2] : "Other";
                return { name: n, repTarget: rt, muscle };
              })
              .filter((x) => x.name);

            if (lines.length === 0) return;
            lines.forEach((x) => ensureLibraryForExercise(x.name, x.muscle));

            const tpl = {
              id: uid(),
              type: "strength",
              name,
              exercises: lines.map((x) => ({ id: uid(), name: x.name, repTarget: x.repTarget })),
            };

            setState((s) => ({ ...s, templates: [tpl, ...s.templates] }));
          } else {
            const tpl = {
              id: uid(),
              type: "cardio",
              name,
              cardio: {
                modality: tplCardioMod,
                minutes: toNum(tplCardioMin) ?? 30,
                distanceKm: tplCardioDist,
              },
            };
            setState((s) => ({ ...s, templates: [tpl, ...s.templates] }));
          }

          setTplName("");
        }

        function deleteTemplate(id) {
          setState((s) => ({
            ...s,
            templates: s.templates.filter((t) => t.id !== id),
            splits: (s.splits || []).map((sp) => ({
              ...sp,
              days: (sp.days || []).map((d) => ({ ...d, templateIds: (d.templateIds || []).filter((tid) => tid !== id) })),
            })),
          }));
        }

        // ---- Splits ----
        const [newSplitName, setNewSplitName] = useState("");
        function createSplit() {
          const name = newSplitName.trim();
          if (!name) return;
          const sp = {
            id: uid(),
            name,
            days: [
              { id: uid(), name: "Day 1", templateIds: [] },
              { id: uid(), name: "Day 2", templateIds: [] },
              { id: uid(), name: "Day 3", templateIds: [] },
              { id: uid(), name: "Day 4", templateIds: [] },
              { id: uid(), name: "Day 5", templateIds: [] },
              { id: uid(), name: "Day 6", templateIds: [] },
              { id: uid(), name: "Day 7", templateIds: [] },
            ],
          };
          setState((s) => ({
            ...s,
            splits: [sp, ...(s.splits || [])],
            activeSplitId: sp.id,
            splitCycleIndexBySplitId: { ...(s.splitCycleIndexBySplitId || {}), [sp.id]: 0 },
          }));
          setNewSplitName("");
        }

        function deleteSplit(splitId) {
          setState((s) => {
            const next = (s.splits || []).filter((sp) => sp.id !== splitId);
            const nextActive = s.activeSplitId === splitId ? (next[0]?.id || null) : s.activeSplitId;

            const nextCycle = { ...(s.splitCycleIndexBySplitId || {}) };
            delete nextCycle[splitId];

            return { ...s, splits: next, activeSplitId: nextActive, splitCycleIndexBySplitId: nextCycle };
          });
        }

        function updateSplit(splitId, updater) {
          setState((s) => ({
            ...s,
            splits: (s.splits || []).map((sp) => (sp.id === splitId ? updater(sp) : sp)),
          }));
        }

        // ---- Exercise history ----
        const exerciseNames = useMemo(() => {
          const set = new Set();
          for (const sess of state.sessions) {
            if (sess.type === "strength" && sess.strength) {
              for (const ex of sess.strength.exercises || []) {
                const n = (ex.name || "").trim();
                if (n) set.add(n);
              }
            }
          }
          return [...set].sort((a, b) => a.localeCompare(b));
        }, [state.sessions]);

        const [historyExercise, setHistoryExercise] = useState("");
        const [historySearch, setHistorySearch] = useState("");

        const historyRows = useMemo(() => {
          if (!historyExercise) return [];
          const rows = [];
          for (const sess of state.sessions) {
            if (sess.type !== "strength" || !sess.strength) continue;
            const ex = (sess.strength.exercises || []).find((e) => (e.name || "").trim() === historyExercise);
            if (!ex) continue;
            const sets = ex.sets || [];
            const bestWeight = Math.max(...sets.map((s) => safe(toNum(s.weight), 0)), 0);
            const bestReps = Math.max(...sets.map((s) => safe(toNum(s.reps), 0)), 0);
            rows.push({
              date: sess.date,
              session: sess.name,
              bestWeight,
              bestReps,
              volume: Math.round(volumeForExercise(ex)),
              setsCount: countedSets(ex),
              repTarget: toNum(ex.repTarget) ?? 8,
            });
          }
          return rows.sort((a, b) => (a.date < b.date ? 1 : -1)).slice(0, 20);
        }, [state.sessions, historyExercise]);

        const historySuggestion = useMemo(() => {
          if (!historyExercise || historyRows.length === 0) return null;
          const latestDate = historyRows[0].date;
          const latestSessName = historyRows[0].session;
          const sess = state.sessions.find((s) => s.date === latestDate && s.name === latestSessName && s.type === "strength");
          if (!sess?.strength) return null;
          const ex = sess.strength.exercises.find((e) => (e.name || "").trim() === historyExercise);
          if (!ex) return null;

          const target = toNum(ex.repTarget) ?? 8;
          const repsNums = (ex.sets || []).map((x) => toNum(x.reps)).filter((x) => x != null);
          const weights = (ex.sets || []).map((x) => toNum(x.weight)).filter((x) => x != null);
          const lastWeight = weights.length ? weights[weights.length - 1] : null;

          const hit = repsNums.length > 0 && repsNums.every((r) => r >= target);
          const miss = repsNums.length > 0 && repsNums.some((r) => r <= Math.max(1, target - 4));
          const next = suggestNextWeight({ lastWeight, hitTargetAllSets: hit, missByALot: miss });

          if (lastWeight == null || next == null) return null;
          return { lastWeight, next };
        }, [historyExercise, historyRows, state.sessions]);

        // ---- Macros ----
        const [macroDate, setMacroDate] = useState(todayISO());
        const [cal, setCal] = useState("");
        const [p, setP] = useState("");
        const [c, setC] = useState("");
        const [f, setF] = useState("");

        const sortedMacros = useMemo(() => [...state.macroEntries].sort((a, b) => (a.date < b.date ? 1 : -1)), [state.macroEntries]);
        function upsertMacros() {
          const entry = { id: uid(), date: macroDate, calories: toNum(cal), protein: toNum(p), carbs: toNum(c), fat: toNum(f) };
          setState((s) => {
            const existing = s.macroEntries.find((m) => m.date === macroDate);
            const next = existing
              ? s.macroEntries.map((m) => (m.date === macroDate ? { ...m, ...entry, id: m.id } : m))
              : [entry, ...s.macroEntries];
            return { ...s, macroEntries: next };
          });
        }
        function deleteMacro(id) {
          setState((s) => ({ ...s, macroEntries: s.macroEntries.filter((m) => m.id !== id) }));
        }

        // ---- Body ----
        const [bodyDate, setBodyDate] = useState(todayISO());
        const [weight, setWeight] = useState("");
        const [bf, setBf] = useState("");

        const sortedBody = useMemo(() => [...state.bodyEntries].sort((a, b) => (a.date < b.date ? 1 : -1)), [state.bodyEntries]);
        function upsertBody() {
          const entry = { id: uid(), date: bodyDate, weightKg: toNum(weight), bodyFatPct: toNum(bf) };
          setState((s) => {
            const existing = s.bodyEntries.find((e) => e.date === bodyDate);
            const next = existing
              ? s.bodyEntries.map((e) => (e.date === bodyDate ? { ...e, ...entry, id: e.id } : e))
              : [entry, ...s.bodyEntries];
            return { ...s, bodyEntries: next };
          });
        }
        function deleteBody(id) {
          setState((s) => ({ ...s, bodyEntries: s.bodyEntries.filter((e) => e.id !== id) }));
        }

        // ---- Weekly summary ----
        const weekSessions = useMemo(() => state.sessions.filter((s) => inWeek(s.date, weekStart)), [state.sessions, weekStart]);

        const weeklyStrength = useMemo(() => {
          const strengthSessions = weekSessions.filter((s) => s.type === "strength" && s.strength);
          let totalVolume = 0;
          let totalSetCount = 0;
          const byMuscle = new Map();

          for (const sess of strengthSessions) {
            for (const ex of sess.strength.exercises || []) {
              totalVolume += volumeForExercise(ex);
              const sets = countedSets(ex);
              totalSetCount += sets;
              const muscle = ex.muscle || state.exerciseLibrary?.[(ex.name || "").trim()]?.muscle || "Other";
              byMuscle.set(muscle, (byMuscle.get(muscle) || 0) + sets);
            }
          }

          const muscleSets = [...byMuscle.entries()]
            .map(([muscle, sets]) => ({ muscle, sets }))
            .sort((a, b) => b.sets - a.sets);

          return { strengthSessionsCount: strengthSessions.length, totalVolume, totalSetCount, muscleSets };
        }, [weekSessions, state.exerciseLibrary]);

        const weeklyCardio = useMemo(() => {
          const cardioSessions = weekSessions.filter((s) => s.type === "cardio" && s.cardio);
          let minutes = 0;
          let distanceKm = 0;
          for (const sess of cardioSessions) {
            minutes += safe(toNum(sess.cardio.minutes), 0);
            distanceKm += safe(toNum(sess.cardio.distanceKm), 0);
          }
          return { cardioSessionsCount: cardioSessions.length, minutes, distanceKm };
        }, [weekSessions]);

        const weeklyMacros = useMemo(() => {
          const ms = state.macroEntries.filter((m) => inWeek(m.date, weekStart));
          if (ms.length === 0) return { days: 0, avg: null };
          const sums = ms.reduce(
            (acc, m) => {
              acc.cal += safe(m.calories, 0);
              acc.p += safe(m.protein, 0);
              acc.c += safe(m.carbs, 0);
              acc.f += safe(m.fat, 0);
              return acc;
            },
            { cal: 0, p: 0, c: 0, f: 0 }
          );
          return {
            days: ms.length,
            avg: {
              calories: Math.round(sums.cal / ms.length),
              protein: Math.round(sums.p / ms.length),
              carbs: Math.round(sums.c / ms.length),
              fat: Math.round(sums.f / ms.length),
            },
          };
        }, [state.macroEntries, weekStart]);

        const weeklyBody = useMemo(() => {
          const bs = [...state.bodyEntries].filter((b) => inWeek(b.date, weekStart)).sort((a, b) => (a.date < b.date ? -1 : 1));
          if (bs.length === 0) return { delta: null, start: null, end: null };
          const start = bs[0];
          const end = bs[bs.length - 1];
          const delta = start.weightKg != null && end.weightKg != null ? +(end.weightKg - start.weightKg).toFixed(2) : null;
          return { delta, start, end };
        }, [state.bodyEntries, weekStart]);

        // ---- Export/Import ----
        function exportData() {
          const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `gym-tracker-pro-v4-backup-${todayISO()}.json`;
          a.click();
          URL.revokeObjectURL(url);
        }
        function importData(file) {
          const reader = new FileReader();
          reader.onload = () => {
            try {
              const parsed = JSON.parse(reader.result);
              setState({
                exerciseLibrary: parsed.exerciseLibrary || {},
                templates: parsed.templates || [],
                splits: parsed.splits || [],
                activeSplitId: parsed.activeSplitId || null,
                settings: parsed.settings || { splitMode: "calendar" },
                splitCycleIndexBySplitId: parsed.splitCycleIndexBySplitId || {},
                sessions: parsed.sessions || [],
                macroEntries: parsed.macroEntries || [],
                bodyEntries: parsed.bodyEntries || [],
              });
            } catch {
              alert("Import failed. Make sure this is a valid backup JSON.");
            }
          };
          reader.readAsText(file);
        }

        // ---- Progression panel ----
        function ProgressionPanel({ session }) {
          if (session.type !== "strength" || !session.strength) return null;

          const recs = (session.strength.exercises || []).map((ex) => {
            const repTarget = toNum(ex.repTarget) ?? 8;
            const sets = ex.sets || [];
            const weights = sets.map((s) => toNum(s.weight)).filter((x) => x != null);
            const lastWeight = weights.length ? weights[weights.length - 1] : null;

            const repsNums = sets.map((s) => toNum(s.reps)).filter((x) => x != null);
            const hitTargetAllSets = repsNums.length > 0 && repsNums.every((r) => r >= repTarget);
            const missByALot = repsNums.length > 0 && repsNums.some((r) => r <= Math.max(1, repTarget - 4));

            const next = suggestNextWeight({ lastWeight, hitTargetAllSets, missByALot });
            return { name: (ex.name || "Unnamed").trim() || "Unnamed", repTarget, lastWeight, next };
          });

          return React.createElement(
            "div",
            { className: "mt-4 rounded-2xl border border-zinc-800 bg-zinc-950/40 p-3" },
            React.createElement("div", { className: "text-sm font-semibold" }, "Progression suggestions (1kg jumps)"),
            React.createElement(
              "div",
              { className: "mt-2 grid gap-2" },
              recs.map((r, i) =>
                React.createElement(
                  "div",
                  { key: i, className: "text-xs text-zinc-300 flex items-center justify-between gap-3" },
                  React.createElement("div", null, `${r.name} (target ${r.repTarget})`),
                  React.createElement("div", { className: "text-zinc-400 text-right" }, r.lastWeight == null ? "Add weight" : `Next: ${r.next} kg`)
                )
              )
            )
          );
        }

        // ---- Render ----
        return React.createElement(
          "div",
          { className: "max-w-5xl mx-auto px-4 py-6 md:py-10" },
          React.createElement(
            "div",
            { className: "flex items-start justify-between gap-4 mb-6" },
            React.createElement(
              "div",
              null,
              React.createElement("div", { className: "text-2xl md:text-3xl font-bold tracking-tight" }, "Gym Tracker Pro (v4)"),
              React.createElement("div", { className: "text-zinc-400 text-sm mt-1" }, "Settings: split mode • Calendar or rolling cycle • Everything local + exportable")
            ),
            React.createElement(
              "div",
              { className: "flex items-center gap-2" },
              React.createElement(Button, { variant: "ghost", onClick: exportData }, "Export"),
              React.createElement("input", {
                type: "file",
                accept: "application/json",
                className: "hidden",
                id: "import-file",
                onChange: (e) => e.target.files?.[0] && importData(e.target.files[0]),
              }),
              React.createElement(Button, { variant: "ghost", onClick: () => document.getElementById("import-file").click() }, "Import")
            )
          ),

          React.createElement(
            "div",
            { className: "flex flex-wrap gap-2 mb-6" },
            React.createElement(Pill, { active: tab === "sessions", onClick: () => setTab("sessions") }, "Track Workouts"),
            React.createElement(Pill, { active: tab === "templates", onClick: () => setTab("templates") }, "Templates"),
            React.createElement(Pill, { active: tab === "split", onClick: () => setTab("split") }, "Split"),
            React.createElement(Pill, { active: tab === "settings", onClick: () => setTab("settings") }, "Settings"),
            React.createElement(Pill, { active: tab === "history", onClick: () => setTab("history") }, "Exercise History"),
            React.createElement(Pill, { active: tab === "macros", onClick: () => setTab("macros") }, "Macros"),
            React.createElement(Pill, { active: tab === "body", onClick: () => setTab("body") }, "Weight & Body Fat"),
            React.createElement(Pill, { active: tab === "weekly", onClick: () => setTab("weekly") }, "Weekly Summary")
          ),

          // ---- Settings ----
          tab === "settings" &&
            React.createElement(
              "div",
              { className: "grid gap-4" },
              React.createElement(
                Card,
                null,
                React.createElement("div", { className: "font-semibold mb-3" }, "Split Settings"),
                React.createElement("div", { className: "grid md:grid-cols-2 gap-3" },
                  React.createElement("div", null,
                    React.createElement(Label, null, "Split mode"),
                    React.createElement(
                      "select",
                      {
                        className:
                          "w-full rounded-xl bg-zinc-950 border border-zinc-800 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-zinc-600",
                        value: state.settings?.splitMode || "calendar",
                        onChange: (e) => setState((s) => ({ ...s, settings: { ...(s.settings || {}), splitMode: e.target.value } })),
                      },
                      React.createElement("option", { value: "calendar" }, "Calendar (Mon–Sun)"),
                      React.createElement("option", { value: "cycle" }, "Rolling Cycle (Day 1..N)")
                    ),
                    React.createElement("div", { className: "text-xs text-zinc-500 mt-2" },
                      (state.settings?.splitMode || "calendar") === "calendar"
                        ? "Uses your weekday to pick a day from the active split."
                        : "Uses a rolling day counter for the active split. Tap “Complete Day” to advance."
                    )
                  ),
                  React.createElement("div", null,
                    React.createElement(Label, null, "Cycle controls"),
                    !state.activeSplitId
                      ? React.createElement("div", { className: "text-sm text-zinc-400" }, "Select an active split first.")
                      : React.createElement(
                          "div",
                          { className: "rounded-2xl border border-zinc-800 bg-zinc-950/40 p-3" },
                          React.createElement("div", { className: "text-sm font-medium" }, "Active split cycle position"),
                          React.createElement("div", { className: "text-xs text-zinc-400 mt-1" }, `Current day index: ${safe(state.splitCycleIndexBySplitId?.[state.activeSplitId], 0) + 1}`),
                          React.createElement("div", { className: "flex gap-2 mt-3" },
                            React.createElement(Button, { variant: "ghost", onClick: () => setCycleIndexForActiveSplit(Math.max(0, getCycleIndexForActiveSplit() - 1)) }, "Back"),
                            React.createElement(Button, { variant: "ghost", onClick: () => setCycleIndexForActiveSplit(getCycleIndexForActiveSplit() + 1) }, "Forward"),
                            React.createElement(Button, { variant: "danger", onClick: () => setCycleIndexForActiveSplit(0) }, "Reset")
                          )
                        )
                  )
                )
              )
            ),

          // ---- Sessions ----
          tab === "sessions" &&
            React.createElement(
              "div",
              { className: "grid gap-4" },
              React.createElement(
                Card,
                null,
                React.createElement("div", { className: "flex items-start justify-between gap-3" },
                  React.createElement("div", null,
                    React.createElement("div", { className: "font-semibold" }, "Today’s Plan"),
                    React.createElement("div", { className: "text-xs text-zinc-400 mt-1" }, activeSplit ? `Active split: ${activeSplit.name}` : "No active split selected")
                  ),
                  React.createElement("div", { className: "flex items-center gap-2" },
                    React.createElement(Button, { variant: "ghost", onClick: () => setTab("settings") }, "Settings"),
                    React.createElement(Button, { variant: "ghost", onClick: () => setTab("split") }, "Edit split")
                  )
                ),
                !plan
                  ? React.createElement("div", { className: "text-sm text-zinc-400 mt-3" }, "No plan available. Choose an active split and assign templates.")
                  : React.createElement(
                      "div",
                      { className: "mt-3" },
                      React.createElement("div", { className: "text-sm font-semibold" }, plan.title),
                      plan.mode === "cycle" &&
                        React.createElement(
                          "div",
                          { className: "flex flex-wrap gap-2 mt-3" },
                          React.createElement(Button, { variant: "ghost", onClick: () => setCycleIndexForActiveSplit(Math.max(0, getCycleIndexForActiveSplit() - 1)) }, "Back"),
                          React.createElement(Button, {
                            onClick: () => {
                              const daysLen = (activeSplit?.days || []).length || 1;
                              setCycleIndexForActiveSplit((getCycleIndexForActiveSplit() + 1) % daysLen);
                            },
                          }, "Complete Day → Next"),
                          React.createElement(Button, { variant: "ghost", onClick: () => setCycleIndexForActiveSplit(0) }, "Reset Cycle")
                        ),
                      plan.templates.length === 0
                        ? React.createElement("div", { className: "text-sm text-zinc-400 mt-2" }, "No templates assigned to this day.")
                        : React.createElement(
                            "div",
                            { className: "flex flex-wrap gap-2 mt-2" },
                            plan.templates.map((t) =>
                              React.createElement(Button, { key: t.id, variant: "ghost", onClick: () => addSessionFromTemplate(t.id) }, "Start: " + t.name)
                            )
                          )
                    )
              ),

              React.createElement(
                Card,
                null,
                React.createElement("div", { className: "font-semibold mb-3" }, "Sessions"),
                sortedSessions.length === 0
                  ? React.createElement(Empty, { title: "No sessions yet", hint: "Start from Today’s Plan or from a template." })
                  : React.createElement(
                      "div",
                      { className: "grid gap-3" },
                      sortedSessions.map((sess) =>
                        React.createElement(
                          "div",
                          { key: sess.id, className: "rounded-2xl border border-zinc-800 bg-zinc-950/40 p-4" },
                          React.createElement(
                            "div",
                            { className: "flex items-start justify-between gap-3" },
                            React.createElement(
                              "div",
                              null,
                              React.createElement("div", { className: "font-semibold" }, `${sess.name} — ${sess.type === "strength" ? "Strength" : "Cardio"}`),
                              React.createElement("div", { className: "text-xs text-zinc-400 mt-0.5" }, sess.date)
                            ),
                            React.createElement("div", { className: "flex items-center gap-2" },
                              React.createElement(Button, { variant: "danger", onClick: () => deleteSession(sess.id) }, "Delete")
                            )
                          ),

                          React.createElement("div", { className: "mt-3" },
                            React.createElement(Label, null, "Notes"),
                            React.createElement(TextArea, {
                              rows: 2,
                              placeholder: "How it felt, cues, next time…",
                              value: sess.notes || "",
                              onChange: (e) => updateSession(sess.id, (s) => ({ ...s, notes: e.target.value })),
                            })
                          ),

                          sess.type === "cardio" &&
                            React.createElement(
                              "div",
                              { className: "mt-3 grid md:grid-cols-4 gap-3" },
                              React.createElement("div", null, React.createElement(Label, null, "Modality"), React.createElement(Input, { value: sess.cardio?.modality || "", onChange: (e) => updateSession(sess.id, (s) => ({ ...s, cardio: { ...s.cardio, modality: e.target.value } })) })),
                              React.createElement("div", null, React.createElement(Label, null, "Minutes"), React.createElement(Input, { inputMode: "numeric", value: sess.cardio?.minutes ?? "", onChange: (e) => updateSession(sess.id, (s) => ({ ...s, cardio: { ...s.cardio, minutes: e.target.value } })) })),
                              React.createElement("div", null, React.createElement(Label, null, "Distance (km)"), React.createElement(Input, { inputMode: "decimal", value: sess.cardio?.distanceKm ?? "", onChange: (e) => updateSession(sess.id, (s) => ({ ...s, cardio: { ...s.cardio, distanceKm: e.target.value } })) })),
                              React.createElement("div", null, React.createElement(Label, null, "Intensity"), React.createElement(Input, { placeholder: "e.g., Zone 2 / Intervals", value: sess.cardio?.intensity ?? "", onChange: (e) => updateSession(sess.id, (s) => ({ ...s, cardio: { ...s.cardio, intensity: e.target.value } })) }))
                            ),

                          sess.type === "strength" &&
                            React.createElement(
                              "div",
                              { className: "mt-4 grid gap-3" },
                              React.createElement(
                                "div",
                                { className: "flex justify-end" },
                                React.createElement(Button, {
                                  variant: "ghost",
                                  onClick: () =>
                                    updateSession(sess.id, (s) => ({
                                      ...s,
                                      strength: {
                                        ...s.strength,
                                        exercises: [
                                          ...(s.strength?.exercises || []),
                                          { id: uid(), name: "", muscle: "Other", repTarget: 8, sets: [{ id: uid(), reps: "", weight: "", rpe: "" }] },
                                        ],
                                      },
                                    })),
                                  children: "+ Exercise",
                                })
                              ),

                              (sess.strength?.exercises || []).map((ex) =>
                                React.createElement(
                                  "div",
                                  { key: ex.id, className: "rounded-2xl border border-zinc-800 bg-zinc-950 p-3" },
                                  React.createElement(
                                    "div",
                                    { className: "grid md:grid-cols-12 gap-2 items-end" },
                                    React.createElement(
                                      "div",
                                      { className: "md:col-span-5" },
                                      React.createElement(Label, null, "Exercise"),
                                      React.createElement(Input, {
                                        value: ex.name,
                                        placeholder: "e.g., Bench Press",
                                        onChange: (e) => {
                                          const newName = e.target.value;
                                          const trimmed = (newName || "").trim();
                                          const autoMuscle = trimmed ? state.exerciseLibrary?.[trimmed]?.muscle : null;

                                          updateSession(sess.id, (s) => ({
                                            ...s,
                                            strength: {
                                              ...s.strength,
                                              exercises: s.strength.exercises.map((x) =>
                                                x.id === ex.id ? { ...x, name: newName, muscle: autoMuscle || x.muscle || "Other" } : x
                                              ),
                                            },
                                          }));

                                          if (trimmed) ensureLibraryForExercise(trimmed, autoMuscle || ex.muscle || "Other");
                                        },
                                      })
                                    ),
                                    React.createElement(
                                      "div",
                                      { className: "md:col-span-3" },
                                      React.createElement(Label, null, "Muscle"),
                                      React.createElement(
                                        "select",
                                        {
                                          className:
                                            "w-full rounded-xl bg-zinc-950 border border-zinc-800 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-zinc-600",
                                          value: ex.muscle || "Other",
                                          onChange: (e) => {
                                            const mus = e.target.value;
                                            updateSession(sess.id, (s) => ({
                                              ...s,
                                              strength: {
                                                ...s.strength,
                                                exercises: s.strength.exercises.map((x) => (x.id === ex.id ? { ...x, muscle: mus } : x)),
                                              },
                                            }));
                                            ensureLibraryForExercise(ex.name, mus);
                                          },
                                        },
                                        MUSCLES.map((m) => React.createElement("option", { key: m, value: m }, m))
                                      )
                                    ),
                                    React.createElement(
                                      "div",
                                      { className: "md:col-span-2" },
                                      React.createElement(Label, null, "Rep target"),
                                      React.createElement(Input, {
                                        inputMode: "numeric",
                                        value: ex.repTarget ?? 8,
                                        onChange: (e) =>
                                          updateSession(sess.id, (s) => ({
                                            ...s,
                                            strength: {
                                              ...s.strength,
                                              exercises: s.strength.exercises.map((x) => (x.id === ex.id ? { ...x, repTarget: e.target.value } : x)),
                                            },
                                          })),
                                      })
                                    ),
                                    React.createElement(
                                      "div",
                                      { className: "md:col-span-2 flex gap-2" },
                                      React.createElement(Button, {
                                        variant: "ghost",
                                        onClick: () =>
                                          updateSession(sess.id, (s) => ({
                                            ...s,
                                            strength: {
                                              ...s.strength,
                                              exercises: s.strength.exercises.map((x) =>
                                                x.id === ex.id ? { ...x, sets: [...(x.sets || []), { id: uid(), reps: "", weight: "", rpe: "" }] } : x
                                              ),
                                            },
                                          })),
                                        children: "+ Set",
                                      }),
                                      React.createElement(Button, {
                                        variant: "danger",
                                        onClick: () =>
                                          updateSession(sess.id, (s) => ({
                                            ...s,
                                            strength: { ...s.strength, exercises: s.strength.exercises.filter((x) => x.id !== ex.id) },
                                          })),
                                        children: "Remove",
                                      })
                                    )
                                  ),

                                  React.createElement(
                                    "div",
                                    { className: "mt-3 grid gap-2" },
                                    (ex.sets || []).map((set, idx) =>
                                      React.createElement(
                                        "div",
                                        { key: set.id, className: "grid grid-cols-12 gap-2 items-center" },
                                        React.createElement("div", { className: "col-span-2 text-xs text-zinc-400" }, "Set " + (idx + 1)),
                                        React.createElement(
                                          "div",
                                          { className: "col-span-3" },
                                          React.createElement(Input, {
                                            inputMode: "numeric",
                                            placeholder: "Reps",
                                            value: set.reps ?? "",
                                            onChange: (e) =>
                                              updateSession(sess.id, (s) => ({
                                                ...s,
                                                strength: {
                                                  ...s.strength,
                                                  exercises: s.strength.exercises.map((x) =>
                                                    x.id === ex.id ? { ...x, sets: x.sets.map((sa) => (sa.id === set.id ? { ...sa, reps: e.target.value } : sa)) } : x
                                                  ),
                                                },
                                              })),
                                          })
                                        ),
                                        React.createElement(
                                          "div",
                                          { className: "col-span-3" },
                                          React.createElement(Input, {
                                            inputMode: "decimal",
                                            placeholder: "Weight (kg)",
                                            value: set.weight ?? "",
                                            onChange: (e) =>
                                              updateSession(sess.id, (s) => ({
                                                ...s,
                                                strength: {
                                                  ...s.strength,
                                                  exercises: s.strength.exercises.map((x) =>
                                                    x.id === ex.id ? { ...x, sets: x.sets.map((sa) => (sa.id === set.id ? { ...sa, weight: e.target.value } : sa)) } : x
                                                  ),
                                                },
                                              })),
                                          })
                                        ),
                                        React.createElement(
                                          "div",
                                          { className: "col-span-2" },
                                          React.createElement(Input, {
                                            inputMode: "decimal",
                                            placeholder: "RPE",
                                            value: set.rpe ?? "",
                                            onChange: (e) =>
                                              updateSession(sess.id, (s) => ({
                                                ...s,
                                                strength: {
                                                  ...s.strength,
                                                  exercises: s.strength.exercises.map((x) =>
                                                    x.id === ex.id ? { ...x, sets: x.sets.map((sa) => (sa.id === set.id ? { ...sa, rpe: e.target.value } : sa)) } : x
                                                  ),
                                                },
                                              })),
                                          })
                                        ),
                                        React.createElement(
                                          "div",
                                          { className: "col-span-2 text-right" },
                                          React.createElement(
                                            Button,
                                            {
                                              variant: "danger",
                                              onClick: () =>
                                                updateSession(sess.id, (s) => ({
                                                  ...s,
                                                  strength: {
                                                    ...s.strength,
                                                    exercises: s.strength.exercises.map((x) =>
                                                      x.id === ex.id ? { ...x, sets: x.sets.filter((sa) => sa.id !== set.id) } : x
                                                    ),
                                                  },
                                                })),
                                            },
                                            "✕"
                                          )
                                        )
                                      )
                                    )
                                  ),

                                  React.createElement(
                                    "div",
                                    { className: "mt-2 text-xs text-zinc-400 flex items-center justify-between" },
                                    React.createElement("div", null, `Sets: ${countedSets(ex)} • Volume: ${Math.round(volumeForExercise(ex))}`),
                                    React.createElement("div", null, ex.name ? "" : "Name the exercise to track it cleanly")
                                  )
                                )
                              ),

                              React.createElement(ProgressionPanel, { session: sess })
                            )
                        )
                      )
                    )
              )
            ),

          // ---- Templates ----
          tab === "templates" &&
            React.createElement(
              "div",
              { className: "grid gap-4" },
              React.createElement(
                Card,
                null,
                React.createElement("div", { className: "font-semibold mb-3" }, "Create template"),
                React.createElement(
                  "div",
                  { className: "grid md:grid-cols-3 gap-3" },
                  React.createElement(
                    "div",
                    null,
                    React.createElement(Label, null, "Template type"),
                    React.createElement(
                      "select",
                      {
                        className:
                          "w-full rounded-xl bg-zinc-950 border border-zinc-800 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-zinc-600",
                        value: tplType,
                        onChange: (e) => setTplType(e.target.value),
                      },
                      React.createElement("option", { value: "strength" }, "Strength"),
                      React.createElement("option", { value: "cardio" }, "Cardio")
                    )
                  ),
                  React.createElement("div", { className: "md:col-span-2" }, React.createElement(Label, null, "Template name"), React.createElement(Input, { value: tplName, onChange: (e) => setTplName(e.target.value) }))
                ),

                tplType === "strength"
                  ? React.createElement(
                      "div",
                      { className: "mt-3" },
                      React.createElement(Label, null, "Exercises (one per line). Format: Exercise,repTarget,Muscle"),
                      React.createElement(TextArea, { rows: 5, value: tplExercises, onChange: (e) => setTplExercises(e.target.value) }),
                      React.createElement("div", { className: "text-xs text-zinc-500 mt-1" }, `Muscle options: ${MUSCLES.join(", ")}`)
                    )
                  : React.createElement(
                      "div",
                      { className: "mt-3 grid md:grid-cols-3 gap-3" },
                      React.createElement("div", null, React.createElement(Label, null, "Modality"), React.createElement(Input, { value: tplCardioMod, onChange: (e) => setTplCardioMod(e.target.value) })),
                      React.createElement("div", null, React.createElement(Label, null, "Minutes"), React.createElement(Input, { inputMode: "numeric", value: tplCardioMin, onChange: (e) => setTplCardioMin(e.target.value) })),
                      React.createElement("div", null, React.createElement(Label, null, "Distance (km) optional"), React.createElement(Input, { inputMode: "decimal", value: tplCardioDist, onChange: (e) => setTplCardioDist(e.target.value) }))
                    ),

                React.createElement("div", { className: "mt-4 flex justify-end" }, React.createElement(Button, { onClick: addTemplate, disabled: !tplName.trim() }, "Save template"))
              ),

              React.createElement(
                Card,
                null,
                React.createElement("div", { className: "font-semibold mb-3" }, "Your templates"),
                state.templates.length === 0
                  ? React.createElement(Empty, { title: "No templates yet", hint: "Create one above." })
                  : React.createElement(
                      "div",
                      { className: "grid gap-3" },
                      state.templates.map((t) =>
                        React.createElement(
                          "div",
                          { key: t.id, className: "rounded-2xl border border-zinc-800 bg-zinc-950/40 p-4 flex items-center justify-between gap-3" },
                          React.createElement("div", null,
                            React.createElement("div", { className: "font-semibold" }, `${t.name}`),
                            React.createElement("div", { className: "text-xs text-zinc-400 mt-1" }, t.type === "strength" ? "Strength" : "Cardio")
                          ),
                          React.createElement("div", { className: "flex items-center gap-2" },
                            React.createElement(Button, { variant: "ghost", onClick: () => addSessionFromTemplate(t.id) }, "Start"),
                            React.createElement(Button, { variant: "danger", onClick: () => deleteTemplate(t.id) }, "Delete")
                          )
                        )
                      )
                    )
              )
            ),

          // ---- Split ----
          tab === "split" &&
            React.createElement(
              "div",
              { className: "grid gap-4" },

              React.createElement(
                Card,
                null,
                React.createElement("div", { className: "font-semibold mb-3" }, "Active Split"),
                React.createElement("div", { className: "grid md:grid-cols-3 gap-3 items-end" },
                  React.createElement("div", { className: "md:col-span-2" },
                    React.createElement(Label, null, "Select active split"),
                    React.createElement(
                      "select",
                      {
                        className:
                          "w-full rounded-xl bg-zinc-950 border border-zinc-800 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-zinc-600",
                        value: state.activeSplitId || "",
                        onChange: (e) => setState((s) => ({ ...s, activeSplitId: e.target.value || null })),
                      },
                      React.createElement("option", { value: "" }, "—"),
                      (state.splits || []).map((sp) => React.createElement("option", { key: sp.id, value: sp.id }, sp.name))
                    )
                  ),
                  React.createElement("div", null,
                    React.createElement(Label, null, "New split"),
                    React.createElement("div", { className: "flex gap-2" },
                      React.createElement(Input, { placeholder: "e.g., My 5-day split", value: newSplitName, onChange: (e) => setNewSplitName(e.target.value) }),
                      React.createElement(Button, { onClick: createSplit, disabled: !newSplitName.trim() }, "Create")
                    )
                  )
                )
              ),

              !activeSplit
                ? React.createElement(Card, null, React.createElement(Empty, { title: "No active split", hint: "Select or create a split above." }))
                : React.createElement(
                    Card,
                    null,
                    React.createElement("div", { className: "flex items-start justify-between gap-3 mb-3" },
                      React.createElement("div", null,
                        React.createElement("div", { className: "font-semibold" }, `Edit: ${activeSplit.name}`),
                        React.createElement("div", { className: "text-xs text-zinc-400 mt-1" }, "Assign templates to each day (7 slots by default, but you can still use cycle mode too)")
                      ),
                      React.createElement(Button, { variant: "danger", onClick: () => deleteSplit(activeSplit.id) }, "Delete split")
                    ),

                    React.createElement("div", { className: "grid gap-3" },
                      (activeSplit.days || []).map((day, idx) => {
                        const weekdayLabel = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"][idx] || `Day ${idx+1}`;
                        return React.createElement(
                          "div",
                          { key: day.id, className: "rounded-2xl border border-zinc-800 bg-zinc-950/40 p-3" },
                          React.createElement("div", { className: "grid md:grid-cols-12 gap-2 items-end" },
                            React.createElement("div", { className: "md:col-span-4" },
                              React.createElement(Label, null, `${weekdayLabel} name`),
                              React.createElement(Input, {
                                value: day.name,
                                onChange: (e) =>
                                  updateSplit(activeSplit.id, (sp) => ({
                                    ...sp,
                                    days: sp.days.map((d) => (d.id === day.id ? { ...d, name: e.target.value } : d)),
                                  })),
                              })
                            ),
                            React.createElement("div", { className: "md:col-span-8" },
                              React.createElement(Label, null, "Templates for this day"),
                              state.templates.length === 0
                                ? React.createElement("div", { className: "text-sm text-zinc-400" }, "Create templates first.")
                                : React.createElement(
                                    "div",
                                    { className: "flex flex-wrap gap-2" },
                                    state.templates.map((t) => {
                                      const checked = (day.templateIds || []).includes(t.id);
                                      return React.createElement(
                                        "label",
                                        { key: t.id, className: "flex items-center gap-2 text-xs border border-zinc-800 rounded-full px-3 py-2 bg-zinc-950/60 cursor-pointer" },
                                        React.createElement("input", {
                                          type: "checkbox",
                                          checked,
                                          onChange: (e) => {
                                            const on = e.target.checked;
                                            updateSplit(activeSplit.id, (sp) => ({
                                              ...sp,
                                              days: sp.days.map((d) => {
                                                if (d.id !== day.id) return d;
                                                const ids = new Set(d.templateIds || []);
                                                if (on) ids.add(t.id);
                                                else ids.delete(t.id);
                                                return { ...d, templateIds: [...ids] };
                                              }),
                                            }));
                                          },
                                        }),
                                        React.createElement("span", null, t.name)
                                      );
                                    })
                                  )
                            )
                          )
                        );
                      })
                    )
                  ),

              React.createElement(
                Card,
                null,
                React.createElement("div", { className: "font-semibold mb-2" }, "Splits"),
                (state.splits || []).length === 0
                  ? React.createElement(Empty, { title: "No splits", hint: "Create one above." })
                  : React.createElement(
                      "div",
                      { className: "grid gap-2" },
                      (state.splits || []).map((sp) =>
                        React.createElement(
                          "div",
                          { key: sp.id, className: "rounded-2xl border border-zinc-800 bg-zinc-950/40 p-3 flex items-center justify-between gap-3" },
                          React.createElement("div", null,
                            React.createElement("div", { className: "text-sm font-medium" }, sp.name),
                            React.createElement("div", { className: "text-xs text-zinc-500 mt-1" }, sp.id === state.activeSplitId ? "Active" : "Inactive")
                          ),
                          React.createElement("div", { className: "flex items-center gap-2" },
                            React.createElement(Button, { variant: "ghost", onClick: () => setState((s) => ({ ...s, activeSplitId: sp.id })) }, "Set active")
                          )
                        )
                      )
                    )
              )
            ),

          // ---- History ----
          tab === "history" &&
            React.createElement(
              "div",
              { className: "grid gap-4" },
              React.createElement(
                Card,
                null,
                React.createElement("div", { className: "font-semibold mb-3" }, "Exercise History"),
                React.createElement("div", { className: "grid md:grid-cols-3 gap-3" },
                  React.createElement("div", { className: "md:col-span-2" },
                    React.createElement(Label, null, "Search"),
                    React.createElement(Input, { placeholder: "Type to filter…", value: historySearch, onChange: (e) => setHistorySearch(e.target.value) })
                  ),
                  React.createElement("div", null,
                    React.createElement(Label, null, "Select exercise"),
                    React.createElement(
                      "select",
                      {
                        className:
                          "w-full rounded-xl bg-zinc-950 border border-zinc-800 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-zinc-600",
                        value: historyExercise,
                        onChange: (e) => setHistoryExercise(e.target.value),
                      },
                      React.createElement("option", { value: "" }, "—"),
                      exerciseNames.filter((n) => n.toLowerCase().includes(historySearch.toLowerCase())).map((n) =>
                        React.createElement("option", { key: n, value: n }, n)
                      )
                    )
                  )
                ),
                historyExercise && historySuggestion
                  ? React.createElement("div", { className: "mt-3 text-sm text-zinc-300" }, `Suggested next load: ${historySuggestion.next} kg (last: ${historySuggestion.lastWeight} kg)`)
                  : React.createElement("div", { className: "mt-3 text-sm text-zinc-400" }, historyExercise ? "Log weights/reps to get a suggestion." : "Pick an exercise to see history.")
              ),
              React.createElement(
                Card,
                null,
                React.createElement("div", { className: "font-semibold mb-3" }, historyExercise ? `Last 20: ${historyExercise}` : "History"),
                !historyExercise
                  ? React.createElement(Empty, { title: "Select an exercise", hint: "Use the dropdown above." })
                  : historyRows.length === 0
                  ? React.createElement(Empty, { title: "No entries yet", hint: "Log this exercise in a Strength session." })
                  : React.createElement(
                      "div",
                      { className: "grid gap-2" },
                      historyRows.map((r, i) =>
                        React.createElement(
                          "div",
                          { key: i, className: "rounded-2xl border border-zinc-800 bg-zinc-950/40 p-3 flex items-center justify-between gap-3" },
                          React.createElement("div", null,
                            React.createElement("div", { className: "text-sm font-medium" }, `${r.date} — ${r.session}`),
                            React.createElement("div", { className: "text-xs text-zinc-400 mt-1" }, `Best: ${r.bestWeight} kg x ${r.bestReps} • Sets: ${r.setsCount} • Volume: ${r.volume}`)
                          )
                        )
                      )
                    )
              )
            ),

          // ---- Macros ----
          tab === "macros" &&
            React.createElement(
              "div",
              { className: "grid gap-4" },
              React.createElement(
                Card,
                null,
                React.createElement("div", { className: "font-semibold mb-3" }, "Log daily macros"),
                React.createElement("div", { className: "grid md:grid-cols-5 gap-3" },
                  React.createElement("div", { className: "md:col-span-2" }, React.createElement(Label, null, "Date"), React.createElement(Input, { type: "date", value: macroDate, onChange: (e) => setMacroDate(e.target.value) })),
                  React.createElement("div", null, React.createElement(Label, null, "Calories"), React.createElement(Input, { inputMode: "numeric", value: cal, onChange: (e) => setCal(e.target.value) })),
                  React.createElement("div", null, React.createElement(Label, null, "Protein (g)"), React.createElement(Input, { inputMode: "numeric", value: p, onChange: (e) => setP(e.target.value) })),
                  React.createElement("div", null, React.createElement(Label, null, "Carbs (g)"), React.createElement(Input, { inputMode: "numeric", value: c, onChange: (e) => setC(e.target.value) }))
                ),
                React.createElement("div", { className: "grid md:grid-cols-5 gap-3 mt-3" },
                  React.createElement("div", { className: "md:col-span-2" }, React.createElement(Label, null, "Fat (g)"), React.createElement(Input, { inputMode: "numeric", value: f, onChange: (e) => setF(e.target.value) })),
                  React.createElement("div", { className: "md:col-span-3 flex items-end justify-end" }, React.createElement(Button, { onClick: upsertMacros }, "Save / Update"))
                )
              ),
              React.createElement(
                Card,
                null,
                React.createElement("div", { className: "font-semibold mb-3" }, "History"),
                sortedMacros.length === 0
                  ? React.createElement(Empty, { title: "No macro entries yet", hint: "Log a day above." })
                  : React.createElement(
                      "div",
                      { className: "grid gap-2" },
                      sortedMacros.map((m) =>
                        React.createElement(
                          "div",
                          { key: m.id, className: "rounded-2xl border border-zinc-800 bg-zinc-950/40 p-3 flex items-center justify-between gap-3" },
                          React.createElement("div", null,
                            React.createElement("div", { className: "text-sm font-medium" }, m.date),
                            React.createElement("div", { className: "text-xs text-zinc-400 mt-1" }, `${m.calories ?? ""} kcal • P ${m.protein ?? ""} • C ${m.carbs ?? ""} • F ${m.fat ?? ""}`)
                          ),
                          React.createElement(Button, { variant: "danger", onClick: () => deleteMacro(m.id) }, "Delete")
                        )
                      )
                    )
              )
            ),

          // ---- Body ----
          tab === "body" &&
            React.createElement(
              "div",
              { className: "grid gap-4" },
              React.createElement(
                Card,
                null,
                React.createElement("div", { className: "font-semibold mb-3" }, "Log body metrics"),
                React.createElement("div", { className: "grid md:grid-cols-3 gap-3" },
                  React.createElement("div", null, React.createElement(Label, null, "Date"), React.createElement(Input, { type: "date", value: bodyDate, onChange: (e) => setBodyDate(e.target.value) })),
                  React.createElement("div", null, React.createElement(Label, null, "Weight (kg)"), React.createElement(Input, { inputMode: "decimal", value: weight, onChange: (e) => setWeight(e.target.value) })),
                  React.createElement("div", null, React.createElement(Label, null, "Body fat (%)"), React.createElement(Input, { inputMode: "decimal", value: bf, onChange: (e) => setBf(e.target.value) }))
                ),
                React.createElement("div", { className: "mt-4 flex justify-end" }, React.createElement(Button, { onClick: upsertBody }, "Save / Update"))
              ),
              React.createElement(
                Card,
                null,
                React.createElement("div", { className: "font-semibold mb-3" }, "History"),
                sortedBody.length === 0
                  ? React.createElement(Empty, { title: "No body entries yet", hint: "Log a day above." })
                  : React.createElement(
                      "div",
                      { className: "grid gap-2" },
                      sortedBody.map((e) =>
                        React.createElement(
                          "div",
                          { key: e.id, className: "rounded-2xl border border-zinc-800 bg-zinc-950/40 p-3 flex items-center justify-between gap-3" },
                          React.createElement("div", null,
                            React.createElement("div", { className: "text-sm font-medium" }, e.date),
                            React.createElement("div", { className: "text-xs text-zinc-400 mt-1" }, `Weight: ${e.weightKg ?? ""} kg • Body fat: ${e.bodyFatPct ?? ""}%`)
                          ),
                          React.createElement(Button, { variant: "danger", onClick: () => deleteBody(e.id) }, "Delete")
                        )
                      )
                    )
              )
            ),

          // ---- Weekly ----
          tab === "weekly" &&
            React.createElement(
              "div",
              { className: "grid gap-4" },
              React.createElement(
                Card,
                null,
                React.createElement("div", { className: "font-semibold mb-3" }, "Pick a week (Monday start)"),
                React.createElement("div", { className: "flex flex-wrap items-center gap-2" },
                  React.createElement(Button, { variant: "ghost", onClick: () => setWeekStart(addDaysISO(weekStart, -7)) }, "← Prev"),
                  React.createElement(Input, { type: "date", value: weekStart, onChange: (e) => setWeekStart(startOfWeekISO(e.target.value)), className: "max-w-[220px]" }),
                  React.createElement(Button, { variant: "ghost", onClick: () => setWeekStart(addDaysISO(weekStart, 7)) }, "Next →")
                ),
                React.createElement("div", { className: "text-xs text-zinc-500 mt-2" }, `Week: ${weekStart} to ${addDaysISO(weekStart, 6)}`)
              ),
              React.createElement(
                Card,
                null,
                React.createElement("div", { className: "font-semibold mb-3" }, "Summary"),
                React.createElement("div", { className: "grid md:grid-cols-3 gap-3" },
                  React.createElement("div", { className: "rounded-2xl border border-zinc-800 bg-zinc-950/40 p-3" },
                    React.createElement("div", { className: "text-xs text-zinc-400" }, "Strength sessions"),
                    React.createElement("div", { className: "text-xl font-semibold" }, weeklyStrength.strengthSessionsCount),
                    React.createElement("div", { className: "text-xs text-zinc-500 mt-1" }, `Sets: ${weeklyStrength.totalSetCount} • Volume: ${Math.round(weeklyStrength.totalVolume)}`)
                  ),
                  React.createElement("div", { className: "rounded-2xl border border-zinc-800 bg-zinc-950/40 p-3" },
                    React.createElement("div", { className: "text-xs text-zinc-400" }, "Cardio sessions"),
                    React.createElement("div", { className: "text-xl font-semibold" }, weeklyCardio.cardioSessionsCount),
                    React.createElement("div", { className: "text-xs text-zinc-500 mt-1" }, `Minutes: ${Math.round(weeklyCardio.minutes)} • Km: ${weeklyCardio.distanceKm.toFixed(1)}`)
                  ),
                  React.createElement("div", { className: "rounded-2xl border border-zinc-800 bg-zinc-950/40 p-3" },
                    React.createElement("div", { className: "text-xs text-zinc-400" }, "Body change"),
                    React.createElement("div", { className: "text-xl font-semibold" }, weeklyBody.delta == null ? "—" : `${weeklyBody.delta > 0 ? "+" : ""}${weeklyBody.delta} kg`),
                    React.createElement("div", { className: "text-xs text-zinc-500 mt-1" }, weeklyBody.start?.weightKg != null && weeklyBody.end?.weightKg != null ? `${weeklyBody.start.date}: ${weeklyBody.start.weightKg} → ${weeklyBody.end.date}: ${weeklyBody.end.weightKg}` : "Add weight entries")
                  )
                )
              )
            ),

          React.createElement("div", { className: "mt-6 text-xs text-zinc-500" }, "Data is stored on this device (localStorage). Export for backups or moving phones.")
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js");
    });
  }
</script>

  </body>
</html>
